class SPA{constructor(route){this.content=document.querySelector("div.content");this.loading=document.querySelector("div.loading").classList;this.model=new Model;this.view=new View;this.controller=new Controller(this.model);window.addEventListener("hashchange",()=>{this.loadingStart();this.model.dataBind={};let page=`${window.location.hash.slice(1).split("?")[0]}`;console.log(page);this.controller[page]().then(()=>{this.renderContent(this.view[page]).bindModelText().parseEvents().twoWayFormBind();this.loadingEnd()})});if(typeof route==="string"){window.location.hash=route}}loadingStart(){this.loading.add("visable");return this}loadingEnd(){this.loading.remove("visable");return this}renderContent(html){this.content.innerHTML=html;return this}update(evt,funcName){this.model[funcName](evt).then(()=>{this.bindModelText().parseEvents().twoWayFormBind()})}parseEvents(){let contents=this.content.querySelectorAll("*[data-event]");contents.forEach(domElem=>{const[evtName,funcName]=domElem.dataset.event.split(":");domElem.addEventListener(evtName,evt=>{return this.update(evt,funcName)});delete domElem.dataset.event});return this}twoWayFormBind(){let form=this.content.querySelector("form[data-bindall]");if(form){form.addEventListener("change",event=>{const target=event.target;const property=target.name;if(property&&target.matches("input")||target.matches("select")){this.model.dataBind[property]=target.value}});delete form.dataset.bindall}return this}bindModelText(){let contents=this.content.querySelectorAll("*[data-bindtext],input[name], select[name]");const obj=this.model.dataBind;if(contents){contents.forEach(domElem=>{const property=domElem.name||domElem.dataset.bindtext;const selector=`*[data-bindText="${property}"],input[name="${property}"], select[name="${property}"]`;let val;if(obj[property]){val=obj[property];if("value"in domElem)domElem.value=val;else if("innerHTML"in domElem)domElem.innerHTML=val}Object.defineProperty(obj,property,{get:function(){return val},set:function(newValue){let elems=document.querySelectorAll(selector);val=newValue;if(elems){elems.forEach(elem=>{if("value"in elem)elem.value=val;else if("innerHTML"in elem)elem.innerHTML=val})}},configurable:true})})}return this}}class Components{static resultsData(data){if(!Array.isArray(data))return"";return`${data.map(row=>`<tr>\n                        <td>${row.author}</td>\n                        <td>${row.rating}</td>\n                        <td>${row.reviewText}</td>\n                        <td><button data-id="${row._id}" data-event="click:deleteReview">Delete</button></td>\n                        <td><button data-id="${row._id}" data-event="click:updatePage">Update</button></td>\n                    </tr>`).join("")}`}}class Controller{constructor(model){this.model=model}home(){return this.model.getReviews()}add(){return Promise.resolve()}test(){return Promise.resolve()}update(){return this.model.updatePageLoad()}}class Model{constructor(){this.APIS={Reviews:"http://localhost:3001/api/v1/reviews/"};this.dataBind={};this.http={get:url=>{return this.httpFetch(url,null,"GET").then(response=>response.json())},post:(url,data)=>{return this.httpFetch(url,data,"POST").then(response=>response.json())},put:(url,data)=>{return this.httpFetch(url,data,"PUT").then(response=>response.json())},delete:url=>{return this.httpFetch(url,null,"DELETE")}}}httpFetch(url,data,verb){let myHeaders=new Headers;myHeaders.set("Content-Type","application/json");let myInit={method:verb,headers:myHeaders,mode:"cors",cache:"default"};if(data){myInit.body=JSON.stringify(data)}const myRequest=new Request(url,myInit);return fetch(myRequest).then(response=>{if(!response.ok)throw Error(response.statusText);return response})}getURLParams(){return new URLSearchParams(window.location.search)}getReviews(){return this.http.get(this.APIS.Reviews).then(data=>{return this.dataBind.reviewTable=Components.resultsData(data)})}saveReviews(){const data={author:this.dataBind.author,rating:this.dataBind.rating,reviewText:this.dataBind.reviewText};return this.http.post(this.APIS.Reviews,data).then(data=>{this.dataBind.saveResultMsg="Review Saved";return data}).catch(err=>{this.dataBind.saveResultMsg="Review NOT Saved";return err})}deleteReview(evt){const url=`${this.APIS.Reviews}${evt.target.dataset.id}`;return this.http.delete(url).then(()=>{return this.dataBind.deleteResultMsg="Review Deleted"}).catch(err=>{return this.dataBind.deleteResultMsg="Review NOT Deleted"}).then(()=>{return this.getReviews()})}updateAuthor(evt){this.dataBind.author=evt.target.value;return Promise.resolve()}updatePage(evt){const params=`?id=${evt.target.dataset.id}`;window.location.href=`${params}#update`;return Promise.resolve()}updatePageLoad(){const url=`${this.APIS.Reviews}${this.getURLParams().get("id")}`;return this.http.get(url).then(data=>{this.dataBind.author=data.author;this.dataBind.rating=data.rating;this.dataBind.reviewText=data.reviewText;this.dataBind._id=data._id;return data})}updateReviews(){const data={author:this.dataBind.author,rating:this.dataBind.rating,reviewText:this.dataBind.reviewText};const url=`${this.APIS.Reviews}${this.dataBind._id}`;return this.http.put(url,data).then(data=>{this.dataBind.updateResultMsg="Review updated";return data}).catch(err=>{this.dataBind.updateResultMsg="Review NOT updated";return err})}}class View{get home(){const html=`<p data-bindtext="deleteResultMsg"></p>\n                      <table>\n                        <thead>\n                            <th>Author</th>\n                            <th>Rating</th>\n                            <th>Review</th>\n                            <th></th>\n                        </thead>\n                        <tbody data-bindtext="reviewTable">                                                    \n                        </tbody>\n                    </table>`;return html}get add(){return`<form data-bindall>\n                        <p>\n                            <label>Author</label>\n                            <input type="text" name="author" data-event="keyup:updateAuthor" />\n                             <p data-bindtext="author"></p>\n                        </p>\n                        <p>\n                            <label>Rating</label>\n                            <select name="rating">\n                                <option value="1">1</option>\n                                <option value="2">2</option>\n                                <option value="3">3</option>\n                                <option value="4">4</option>\n                                <option value="5">5</option>\n                            </select>\n                        </p>\n                        <p>\n                            <label>Review</label>\n                            <input type="text" name="reviewText" />\n                        </p>\n                        <p data-bindtext="saveResultMsg"></p>\n                        <p> <input type="button" value="submit" data-event="click:saveReviews" /> </p>\n                    </form>`}get test(){return"test"}get update(){return`<form data-bindall>\n                    <p>Update</p>\n                    <p>\n                        <label>Author</label>\n                        <input type="text" name="author" />\n                    </p>\n                    <p>\n                        <label>Rating</label>\n                        <select name="rating">\n                            <option value="1">1</option>\n                            <option value="2">2</option>\n                            <option value="3">3</option>\n                            <option value="4">4</option>\n                            <option value="5">5</option>\n                        </select>\n                    </p>\n                    <p>\n                        <label>Review</label>\n                        <input type="text" name="reviewText" />\n                    </p>\n                    <p data-bindtext="updateResultMsg"></p>\n                    <p> <input type="button" value="submit" data-event="click:updateReviews" /> </p>\n                </form>`}}